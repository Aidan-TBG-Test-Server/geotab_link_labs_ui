<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <h1>hello World</h1>
</body>
<script defer type="text/javascript">
    console.log("running test Addin")
    function isAuthenticated() {
        return !!localStorage.getItem('authToken');
    }
    async function geotab_sso(session) {
        try {
            const response = await fetch('https://access-conductor.link-labs.com/access/geotab/sso', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: session.userName,
                    database: session.database,
                    sessionId: session.sessionId
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();
            const token = data.token;

            if (token) {
                localStorage.setItem('authToken', token);
                return true;
            } else {
                console.warn('Token not found in response.');
                return false;
            }
        } catch (error) {
            console.error('Error during SSO authentication:', error);
            return false;
        }
    }
    geotab.addin.mySolutionSSO = function () {
        console.log("inside the lifecycle function")

        return {
            initialize(api, state, addInReady) {

                console.log("initialize");
                if (isAuthenticated()) {
                    // Nothing to do, user is authenticated.
                    addInReady();
                    return;
                }
                api.getSession(
                    (session) => {
                        console.log("session:")
                        console.dir(session, { depth: null, colors: true });

                        try {
                            geotab_sso(session).then(
                                (successfully_authenticated) => {
                                    if (successfully_authenticated) {
                                        console.log('Successfully authenticated with Geotab SSO.');
                                    } else {
                                        console.warn('Failed to authenticate with Geotab SSO.');
                                    }
                                    if (!!addInReady) {
                                        addInReady()
                                    }
                                }
                            );
                        } catch (error) {
                            console.error('Unexpected error authenticating to Link Labs:', error);
                        }
                    },
                    false
                );
            },

            focus: function (api, state) {

                // document.write("Hi")
                console.log("focus")
                // document.write("<strong>Hey!! - focus</strong>")

            },

            blur: function (api, state) {

            }
        }
    }
    console.log("lifecycle called")

</script>

</html>